name: Tailscale HTTPS Landing Page

on:
  push:
  workflow_dispatch:
    inputs:
      keep_alive_minutes:
        description: 'Minutes to keep the server running (max 20)'
        required: false
        default: '20'

# Only allow one instance to run at a time
concurrency:
  group: tailscale-nginx
  cancel-in-progress: false

jobs:
  tailscale-nginx:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nginx curl jq

      - name: Connect to Tailscale
        uses: 4
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}

      - name: Print Tailscale Debug Info
        run: |
          echo "=========================================="
          echo "TAILSCALE STATUS"
          echo "=========================================="
          tailscale status
          echo ""
          echo "=========================================="
          echo "TAILSCALE IP"
          echo "=========================================="
          tailscale ip -4
          tailscale ip -6
          echo ""
          echo "=========================================="
          echo "TAILSCALE NETCHECK"
          echo "=========================================="
          tailscale netcheck
          echo ""
          echo "=========================================="
          echo "TAILSCALE DEBUG INFO"
          echo "=========================================="
          tailscale debug prefs
          echo ""
          echo "=========================================="
          echo "HOSTNAME AND FQDN"
          echo "=========================================="
          hostname
          tailscale status --json | jq -r '.Self.DNSName'
          echo ""
          echo "=========================================="
          echo "NETWORK INTERFACES"
          echo "=========================================="
          ip addr
          echo ""
          echo "=========================================="
          echo "ROUTING TABLE"
          echo "=========================================="
          ip route

      - name: Get Tailnet FQDN
        id: fqdn
        run: |
          # Get the tailnet FQDN (remove trailing dot if present)
          TAILNET_FQDN=$(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
          echo "fqdn=$TAILNET_FQDN" >> $GITHUB_OUTPUT
          echo "Tailnet FQDN: $TAILNET_FQDN"

      - name: Obtain SSL Certificate from Tailscale
        run: |
          FQDN="${{ steps.fqdn.outputs.fqdn }}"
          echo "Requesting SSL certificate for: $FQDN"
          
          # Create directory for certs
          sudo mkdir -p /etc/nginx/ssl
          
          # Get the SSL certificate from Tailscale
          sudo tailscale cert \
            --cert-file /etc/nginx/ssl/server.crt \
            --key-file /etc/nginx/ssl/server.key \
            "$FQDN"
          
          echo ""
          echo "=========================================="
          echo "CERTIFICATE INFO"
          echo "=========================================="
          sudo openssl x509 -in /etc/nginx/ssl/server.crt -text -noout | head -30
          
          # Set proper permissions
          sudo chmod 600 /etc/nginx/ssl/server.key
          sudo chmod 644 /etc/nginx/ssl/server.crt

      - name: Create Landing Page
        run: |
          FQDN="${{ steps.fqdn.outputs.fqdn }}"
          TAILSCALE_IP=$(tailscale ip -4)
          
          sudo mkdir -p /var/www/html
          sudo tee /var/www/html/index.html > /dev/null <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Tailscale HTTPS Landing Page</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: #fff;
                  }
                  .container {
                      background: rgba(255, 255, 255, 0.1);
                      backdrop-filter: blur(10px);
                      border-radius: 20px;
                      padding: 40px 60px;
                      text-align: center;
                      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                      border: 1px solid rgba(255, 255, 255, 0.1);
                      max-width: 600px;
                  }
                  h1 {
                      font-size: 2.5rem;
                      margin-bottom: 20px;
                      background: linear-gradient(90deg, #00d9ff, #00ff88);
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      background-clip: text;
                  }
                  .status {
                      background: #00ff88;
                      color: #1a1a2e;
                      padding: 8px 20px;
                      border-radius: 50px;
                      display: inline-block;
                      font-weight: 600;
                      margin-bottom: 30px;
                  }
                  .info {
                      text-align: left;
                      background: rgba(0, 0, 0, 0.2);
                      padding: 20px;
                      border-radius: 10px;
                      margin-top: 20px;
                  }
                  .info-row {
                      display: flex;
                      justify-content: space-between;
                      padding: 10px 0;
                      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                  }
                  .info-row:last-child { border-bottom: none; }
                  .label { color: #888; }
                  .value { color: #00d9ff; font-family: monospace; }
                  .lock-icon { font-size: 3rem; margin-bottom: 20px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="lock-icon">ðŸ”’</div>
                  <h1>Secure Connection</h1>
                  <div class="status">HTTPS Active</div>
                  <p>This page is served over HTTPS with a valid SSL certificate from Tailscale.</p>
                  <div class="info">
                      <div class="info-row">
                          <span class="label">Hostname</span>
                          <span class="value">${FQDN}</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Tailscale IP</span>
                          <span class="value">${TAILSCALE_IP}</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Certificate</span>
                          <span class="value">Let's Encrypt (via Tailscale)</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Generated</span>
                          <span class="value">$(date -u '+%Y-%m-%d %H:%M:%S UTC')</span>
                      </div>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Configure Nginx for HTTPS
        run: |
          FQDN="${{ steps.fqdn.outputs.fqdn }}"
          
          sudo tee /etc/nginx/sites-available/tailscale-https > /dev/null <<EOF
          server {
              listen 80;
              server_name ${FQDN};
              return 301 https://\$server_name\$request_uri;
          }

          server {
              listen 443 ssl http2;
              server_name ${FQDN};

              ssl_certificate /etc/nginx/ssl/server.crt;
              ssl_certificate_key /etc/nginx/ssl/server.key;

              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
              ssl_prefer_server_ciphers off;

              root /var/www/html;
              index index.html;

              location / {
                  try_files \$uri \$uri/ =404;
              }
          }
          EOF

          # Enable the site
          sudo ln -sf /etc/nginx/sites-available/tailscale-https /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default

          # Test nginx configuration
          sudo nginx -t

      - name: Start Nginx
        run: |
          sudo systemctl restart nginx
          sudo systemctl status nginx

      - name: Print Access Information
        run: |
          FQDN="${{ steps.fqdn.outputs.fqdn }}"
          TAILSCALE_IP=$(tailscale ip -4)
          KEEP_ALIVE="${{ github.event.inputs.keep_alive_minutes || '20' }}"
          
          echo ""
          echo "=========================================="
          echo "ðŸš€ SERVER IS NOW RUNNING!"
          echo "=========================================="
          echo ""
          echo "Access your secure landing page at:"
          echo ""
          echo "  ðŸ”’ https://${FQDN}"
          echo ""
          echo "Or via Tailscale IP:"
          echo ""
          echo "  ðŸ“ https://${TAILSCALE_IP} (certificate warning expected)"
          echo ""
          echo "=========================================="
          echo "The server will stay up for ${KEEP_ALIVE} minutes."
          echo "=========================================="
          echo ""

      - name: Verify HTTPS is working
        run: |
          FQDN="${{ steps.fqdn.outputs.fqdn }}"
          echo "Testing HTTPS connection..."
          curl -sS --max-time 10 "https://${FQDN}" | head -20
          echo ""
          echo "âœ… HTTPS is working!"

      - name: Keep server running
        run: |
          KEEP_ALIVE="${{ github.event.inputs.keep_alive_minutes || '20' }}"
          SECONDS_TO_WAIT=$((KEEP_ALIVE * 60))
          
          echo "Keeping server alive for ${KEEP_ALIVE} minutes (${SECONDS_TO_WAIT} seconds)..."
          echo "You can access the server during this time."
          echo ""
          
          # Print a status update every minute
          for ((i=1; i<=KEEP_ALIVE; i++)); do
            sleep 60
            REMAINING=$((KEEP_ALIVE - i))
            echo "[$(date '+%H:%M:%S')] Server running... ${REMAINING} minutes remaining"
          done
          
          echo ""
          echo "Time's up! Server shutting down."
